# notabenoid-dockerfile

*Великий создатель Нотабеноида, Дмитрий Ромахин, никогда не упускал возможности писать бодро. Также поступим и мы.*

Это штуковина есть имеджи для Докера, в мгновение ока поднимающие Нотабеноид. Причем подходит для всего: для быстрой демки, для сурового продакшена или, не дай Бог, для дальнейшей разработки этой безупречной системы.

## Подготовка

Всё, что описано ниже, разрабатывалось и тестировалось на витруальной машинке с Убунту Десктоп. Минимально, надо, конечно, [установить Докер](https://docs.docker.com/installation/ubuntulinux/) и потребуется Git.

Теперь надо склонировать репозиторий со докер-скриптами и перейти в его каталог:
```bash
git clone https://github.com/THIS_REPOSITORY.git notabenoid-dockerfile
cd notabenoid-dockerfile
```

Далее надо откомпайлить имидж, на базе которого мы позже будем запускать контейнеры. Если нам оно только для попробовать или для разработки надо, то можно смело запускать команду внизу, а вот если мы это дело для продакшена хотим, то надо непременно открыть в редакторе файл `Dockerfile` и там, где в начале строки видим `ENV`, вбиваем свои значения переменных.
```bash
docker build -t notabenoid .
```


## Если хочется просто попробовать запустить Нотку и пощелкать мышкой

Просто запускаем временный контейнер:
```bash
docker run --rm -p 127.0.0.1:8080:80 --name notabenoid notabenoid
```

Теперь направляем любимый браузер на: http://127.0.0.1:8080/ и логинимся c именем `admin` и паролем `admin`.

## Если надо запустить в продакшене

Для начала надо открыть в редакторе файл `Dockerfile` и там, где в начале строки видим `ENV`, надо вбить свои значения переменных.

Далее выполняем следующие действия:
```bash
# Компайлим имидж Нотки, после того поправили переменные
docker build -t notabenoid .

# Создаем отдельный каталог, например, /var/notabenoid
mkdir /var/notabenoid

# Создаем и запускаем контейнер с Ноткой,
# который маунтит всё самое драгоценное вам на локальный диск
docker run -d --name notabenoid -p 127.0.0.1:8080:80 -v /var/notabenoid/dbdata:/notabenoid/dbdata -v /var/notabenoid/files:/notabenoid/files notabenoid
```

Теперь направляем браузер на: http://127.0.0.1:8080/ , логинимся c именем `admin` и паролем `admin`, и **незамедлительно меняем пароль**.

Вольюмы на `dbdata` и `files` позволяют рестартовать имидж или пересоздавать контейнер без потери данных. 

**Настоятельно рекомендуется** рабочий каталожик (в данном случае `/var/notabenoid`) полностью бакапить!

#### По поводу посылки почты

*В данный момент посылка почты не настроена! Может кто-то доработает имидж, а пока надо самому выкручиваться, если почта нужна.*

Нотабеноид иногда посылает письма. Его код использует `Yii::app()->mail->send($msg)` для посылки почты, который по умолчанию использует стандартную пхпэшную функцию `mail`. Ее конфигурация находится в файле `/etc/php5/fpm/php.ini` в категории `[mail function]`, где стоит, что SMTP находится по адресу `localhost:25`. Но так как по этому адресу никакого SMTP нет, то почта, соответственно, никуда не посылается. Ну, а дальше надо что-то думать с этим.

## Если хочется помучать код Нотабеноида

```bash
# Переходим в отдельный каталог, например, в вот такой ~/notabenoid
cd ~ && mkdir notabenoid && cd notabenoid

# Клоним код Нотки в директорий site:
git clone https://github.com/notabenoid/notabenoid.git site

# Далее запускаем контейнер, который маунтит всё самое драгоценное
# вам на локальный диск, включая код приложения
# (контейнер можно создавать и не временный, т.е. без --rm)
docker run --rm --name notabenoid -p 127.0.0.1:8080:80 -v $(pwd)/site:/notabenoid/site -v $(pwd)/dbdata:/notabenoid/dbdata -v $(pwd)/files:/notabenoid/files notabenoid
```

Теперь контейнер берет файлы приложения с локального диска из каталога `site`, поэтому можно делать изменения прямо в локальном гит-клоне и напрямую тестить в браузере. 

Вольюмы на `dbdata` и `files` позволяют рестартовать имидж или пересоздавать контейнер без потери данных.

### Полезняшки для разработки

Для захода в контейнер Нотки через шеллку:
```bash
docker exec -it notabenoid bash
```

Если мы внутри контейнера в шеллке, но хочется Миднайт Командером попользоваться:
```bash
apt-get update && apt-get install -y mc && export TERM=xterm && mc
```

Если нужно поиграться с базой данных:
```bash
docker exec -it notabenoid bash -c 'export TERM=xterm && psql notabenoid -U notabenoid'
```

Если хочется просто порезвиться в шеллке чистой Убунты:
```bash
docker run --rm -it ubuntu bash
```

## Каталоги внутри контейнера

Всё самое важное лежит в `/notabenoid`:

* `/notabenoid/site` - код Нотки
* `/notabenoid/dbdata` - база данных Нотки (Постгрес)
* `/notabenoid/files` - загруженные пользователями файлы (аватарки)
* `/notabenoid/tmp` - всякая временная борода